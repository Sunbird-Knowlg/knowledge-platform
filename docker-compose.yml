version: "3.0"
services:
  sunbird-yugabyte:
    image: yugabytedb/yugabyte:latest
    container_name: "sunbird_yugabyte"
    ports:
      - 9042:9042  # YCQL (Cassandra-compatible) port
      - 5434:5433  # YSQL (PostgreSQL-compatible) port - mapped to 5434
      - 7001:7000  # Master webserver (mapped to 7001 to avoid conflicts)
      - 9001:9000  # Master RPC (mapped to 9001 to avoid conflicts)
    volumes:
      - $sunbird_dbs_path/yugabyte/data:/home/yugabyte/yb_data
    command: ["bin/yugabyted", "start", "--daemon=false", "--ui=false"]
    healthcheck:
      test: ["CMD", "bin/yugabyted", "status"]
      interval: 10s
      timeout: 5s
      retries: 10

  sunbird-janusgraph:
    image: docker.io/bitnamilegacy/janusgraph:1.1.0-debian-12-r21
    container_name: "sunbird_janusgraph"
    ports:
      - 8182:8182  # Gremlin Server port
    depends_on:
      sunbird-yugabyte:
        condition: service_healthy
    volumes:
      - $sunbird_dbs_path/janusgraph/data:/bitnami/janusgraph/data
      - $sunbird_dbs_path/janusgraph/logs:/bitnami/janusgraph/logs
      - ./janusgraph-cql.properties:/opt/bitnami/janusgraph/conf/janusgraph-cql.properties
      - $sunbird_dbs_path/janusgraph/janus-data:/data
      - ./gremlin-server.yaml:/opt/bitnami/janusgraph/conf/gremlin-server.yaml
    environment:
      - JANUSGRAPH_STORAGE_BACKEND=cql
      - JANUSGRAPH_STORAGE_HOSTNAME=sunbird-yugabyte
      - JANUSGRAPH_STORAGE_PORT=9042
      - JANUSGRAPH_CFG_storage_cql_keyspace=janusgraph
      - JANUSGRAPH_CFG_storage_directory=/bitnami/janusgraph/data
    entrypoint:
      - /opt/bitnami/janusgraph/bin/janusgraph-server.sh
      - /opt/bitnami/janusgraph/conf/gremlin-server.yaml

  sunbird-redis: 
    image: redis:6.0.8
    container_name: "sunbird_redis"
    ports:
      - 6379:6379
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
     - $sunbird_dbs_path/redis/redis.conf:/usr/local/etc/redis/redis.conf

networks:
  default:
    name: janus-net