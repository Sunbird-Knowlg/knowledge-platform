version: "3.0"
services:
  sunbird-yugabyte:
    image: yugabytedb/yugabyte:latest
    container_name: "sunbird_yugabyte"
    ports:
      - 9042:9042  # YCQL (Cassandra-compatible) port
      - 5434:5433  # YSQL (PostgreSQL-compatible) port - mapped to 5434
      - 7001:7000  # Master webserver (mapped to 7001 to avoid conflicts)
      - 9001:9000  # Master RPC (mapped to 9001 to avoid conflicts)
    volumes:
      - $sunbird_dbs_path/yugabyte/data:/home/yugabyte/yb_data
    command: ["bin/yugabyted", "start", "--daemon=false", "--ui=false"]
    healthcheck:
      test: ["CMD", "bin/yugabyted", "status"]
      interval: 10s
      timeout: 5s
      retries: 10

  sunbird-janusgraph:
    image: janusgraph/janusgraph:latest
    container_name: "sunbird_janusgraph"
    ports:
      - 8182:8182  # Gremlin Server port
    depends_on:
      sunbird-yugabyte:
        condition: service_healthy
    volumes:
      - $sunbird_dbs_path/janusgraph/data:/var/lib/janusgraph/data
      - $sunbird_dbs_path/janusgraph/logs:/var/lib/janusgraph/logs
    environment:
      - JANUS_PROPS_TEMPLATE=cql
      - janusgraph.storage.backend=cql
      - janusgraph.storage.hostname=sunbird-yugabyte
      - janusgraph.storage.port=9042
      - janusgraph.storage.cql.keyspace=janusgraph

  sunbird-redis: 
    image: redis:6.0.8
    container_name: "sunbird_redis"
    ports:
      - 6380:6379  # Redis port - mapped to 6380 to avoid conflicts
    command: redis-server
    volumes:
     - $sunbird_dbs_path/redis:/data

  zookeeper:
    image: 'wurstmeister/zookeeper:latest'
    container_name: zookeeper
    ports:
      - "2181:2181"    
    environment:
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://127.0.0.1:2181     
    
  kafka:
    image: 'wurstmeister/kafka:2.12-2.5.1'
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_LISTENERS=PLAINTEXT://:9092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://127.0.0.1:9092
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181      
      - ALLOW_PLAINTEXT_LISTENER=yes
    depends_on:
      - zookeeper  